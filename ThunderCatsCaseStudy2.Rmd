---
title: "Thundercats Case Study 2"
author: "TEAM THUNDERCATS DDS SMU"
date: "7/29/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(sqldf)
library(dplyr)
```

## Load the data
```{r}
attrition_data = read.csv('atttrition.csv', stringsAsFactors=TRUE)

```
## EDA Phase 1: Plotting
  
  # By Age (abstract into histogram analysis?)
```{r}
#let's partiton by attrition and look at the data a bit
left_data = sqldf("SELECT * FROM attrition_data WHERE Attrition = 'Yes'")
stayed_data = sqldf("SELECT * FROM attrition_data WHERE Attrition = 'No'")

ggplot(data=left_data, aes(left_data$Age)) + geom_histogram(binwidth = 3) 
ggplot(data=stayed_data, aes(stayed_data$Age)) + geom_histogram(binwidth = 3) 

```

```{r}
#helper function for quick viz of percentage of employees that have left
attrition_by_category <- function(category){

sql_statement = glue::glue('SELECT 
                                  {category}
                                  ,Attrition
                                  ,COUNT(*)*1.0  as Count
                             FROM attrition_data 
                             GROUP BY {category}
                                     , Attrition')  
  
counts = sqldf(sql_statement)

yes =sqldf("SELECT * FROM counts WHERE Attrition = 'Yes'")
no =sqldf("SELECT * FROM counts WHERE Attrition = 'No'")

yes_bar = ggplot(yes, aes(x=yes[,category], y=yes$Count, fill=yes[,category])) + geom_bar(stat = "identity") + labs(x = category, y='# Attrition', fill=category) 
no_bar = ggplot(no, aes(x=no[,category], y=no$Count, fill=no[,category])) + geom_bar(stat = "identity") + labs(x = category, y='# Attrition', fill=category) 

attrition_rates = sqldf(glue::glue('SELECT
          y.{category},
          y.Count as Departed,
          n.Count as Employed,
          (y.Count/(n.Count + y.Count)) as AttritionRate
       FROM yes y
       LEFT JOIN no n ON n.{category} = y.{category}'))
plot(no_bar)
plot(yes_bar)
print(attrition_rates)
#return(list(attrition_rates, yes_bar, no_bar))
}

#helper function for extracting col names
#TODO: add cols that are factors but also ints 
factor_columns <- function(dataFrame){
  return(colnames(dataFrame[,sapply(dataFrame, is.factor) & colnames(dataFrame) != "id"]))
}
```

 # Analysis by factor


```{r}
factors = factor_columns(attrition_data)
for(f in factors){
  attrition_by_category(f)
}

```
